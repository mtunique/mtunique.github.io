<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>浅析 Flink Table/SQL API | mtunique blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="浅析 Flink Table/SQL API"><meta property="og:description" content="从何而来 关系型API有很多好处：是声明式的，用户只需要告诉需要什么，系统决定如何计算；用户不必特地实现；更方便优化，可以执行得更高效。本身Flink就是一个统一批和流的分布式计算平台，所以社区设计关系型API的目的之一是可以让关系型API作为统一的一层，两种查询拥有同样的语义和语法。大多数流处理框架的API都是比较low-level的API，学习成本高而且很多逻辑需要写到UDF中，所以Apache Flink 添加了SQL-like的API处理关系型数据&ndash;Table API。这套API中最重要的概念是Table(可以在上面进行关系型操作的结构化的DataSet或DataStream)。Table API 与 DataSet和DataStream API 结合紧密，DataSet 和 DataStream都可以很容易地转换成 Table，同样转换回来也很方便：
val execEnv = ExecutionEnvironment.getExecutionEnvironment val tableEnv = TableEnvironment.getTableEnvironment(execEnv) // obtain a DataSet from somewhere val tempData: DataSet[(String, Long, Double)] = // convert the DataSet to a Table val tempTable: Table = tempData.toTable(tableEnv, 'location, 'time, 'tempF) // compute your result val avgTempCTable: Table = tempTable .where('location.like(&#34;room%&#34;)) .select( ('time / (3600 * 24)) as 'day, 'Location as 'room, (('tempF - 32) * 0."><meta property="og:type" content="article"><meta property="og:url" content="https://mtunique.com/posts/flink_sql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-21T22:30:27+08:00"><meta property="article:modified_time" content="2017-03-21T22:30:27+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="浅析 Flink Table/SQL API"><meta name=twitter:description content="从何而来 关系型API有很多好处：是声明式的，用户只需要告诉需要什么，系统决定如何计算；用户不必特地实现；更方便优化，可以执行得更高效。本身Flink就是一个统一批和流的分布式计算平台，所以社区设计关系型API的目的之一是可以让关系型API作为统一的一层，两种查询拥有同样的语义和语法。大多数流处理框架的API都是比较low-level的API，学习成本高而且很多逻辑需要写到UDF中，所以Apache Flink 添加了SQL-like的API处理关系型数据&ndash;Table API。这套API中最重要的概念是Table(可以在上面进行关系型操作的结构化的DataSet或DataStream)。Table API 与 DataSet和DataStream API 结合紧密，DataSet 和 DataStream都可以很容易地转换成 Table，同样转换回来也很方便：
val execEnv = ExecutionEnvironment.getExecutionEnvironment val tableEnv = TableEnvironment.getTableEnvironment(execEnv) // obtain a DataSet from somewhere val tempData: DataSet[(String, Long, Double)] = // convert the DataSet to a Table val tempTable: Table = tempData.toTable(tableEnv, 'location, 'time, 'tempF) // compute your result val avgTempCTable: Table = tempTable .where('location.like(&#34;room%&#34;)) .select( ('time / (3600 * 24)) as 'day, 'Location as 'room, (('tempF - 32) * 0."><link rel=stylesheet href=https://mtunique.com/css/style-dark.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://mtunique.com/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://mtunique.com/posts/spark_flink_mem/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i></a></li><li><a class=icon href=https://mtunique.com/posts/flink_sql_outlook/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&text=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&title=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&is_video=false&description=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API&body=Check out this article: https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&title=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&title=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&name=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API&description=%e4%bb%8e%e4%bd%95%e8%80%8c%e6%9d%a5%20%e5%85%b3%e7%b3%bb%e5%9e%8bAPI%e6%9c%89%e5%be%88%e5%a4%9a%e5%a5%bd%e5%a4%84%ef%bc%9a%e6%98%af%e5%a3%b0%e6%98%8e%e5%bc%8f%e7%9a%84%ef%bc%8c%e7%94%a8%e6%88%b7%e5%8f%aa%e9%9c%80%e8%a6%81%e5%91%8a%e8%af%89%e9%9c%80%e8%a6%81%e4%bb%80%e4%b9%88%ef%bc%8c%e7%b3%bb%e7%bb%9f%e5%86%b3%e5%ae%9a%e5%a6%82%e4%bd%95%e8%ae%a1%e7%ae%97%ef%bc%9b%e7%94%a8%e6%88%b7%e4%b8%8d%e5%bf%85%e7%89%b9%e5%9c%b0%e5%ae%9e%e7%8e%b0%ef%bc%9b%e6%9b%b4%e6%96%b9%e4%be%bf%e4%bc%98%e5%8c%96%ef%bc%8c%e5%8f%af%e4%bb%a5%e6%89%a7%e8%a1%8c%e5%be%97%e6%9b%b4%e9%ab%98%e6%95%88%e3%80%82%e6%9c%ac%e8%ba%abFlink%e5%b0%b1%e6%98%af%e4%b8%80%e4%b8%aa%e7%bb%9f%e4%b8%80%e6%89%b9%e5%92%8c%e6%b5%81%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%a1%e7%ae%97%e5%b9%b3%e5%8f%b0%ef%bc%8c%e6%89%80%e4%bb%a5%e7%a4%be%e5%8c%ba%e8%ae%be%e8%ae%a1%e5%85%b3%e7%b3%bb%e5%9e%8bAPI%e7%9a%84%e7%9b%ae%e7%9a%84%e4%b9%8b%e4%b8%80%e6%98%af%e5%8f%af%e4%bb%a5%e8%ae%a9%e5%85%b3%e7%b3%bb%e5%9e%8bAPI%e4%bd%9c%e4%b8%ba%e7%bb%9f%e4%b8%80%e7%9a%84%e4%b8%80%e5%b1%82%ef%bc%8c%e4%b8%a4%e7%a7%8d%e6%9f%a5%e8%af%a2%e6%8b%a5%e6%9c%89%e5%90%8c%e6%a0%b7%e7%9a%84%e8%af%ad%e4%b9%89%e5%92%8c%e8%af%ad%e6%b3%95%e3%80%82%e5%a4%a7%e5%a4%9a%e6%95%b0%e6%b5%81%e5%a4%84%e7%90%86%e6%a1%86%e6%9e%b6%e7%9a%84API%e9%83%bd%e6%98%af%e6%af%94%e8%be%83low-level%e7%9a%84API%ef%bc%8c%e5%ad%a6%e4%b9%a0%e6%88%90%e6%9c%ac%e9%ab%98%e8%80%8c%e4%b8%94%e5%be%88%e5%a4%9a%e9%80%bb%e8%be%91%e9%9c%80%e8%a6%81%e5%86%99%e5%88%b0UDF%e4%b8%ad%ef%bc%8c%e6%89%80%e4%bb%a5Apache%20Flink%20%e6%b7%bb%e5%8a%a0%e4%ba%86SQL-like%e7%9a%84API%e5%a4%84%e7%90%86%e5%85%b3%e7%b3%bb%e5%9e%8b%e6%95%b0%e6%8d%ae%26ndash%3bTable%20API%e3%80%82%e8%bf%99%e5%a5%97API%e4%b8%ad%e6%9c%80%e9%87%8d%e8%a6%81%e7%9a%84%e6%a6%82%e5%bf%b5%e6%98%afTable%28%e5%8f%af%e4%bb%a5%e5%9c%a8%e4%b8%8a%e9%9d%a2%e8%bf%9b%e8%a1%8c%e5%85%b3%e7%b3%bb%e5%9e%8b%e6%93%8d%e4%bd%9c%e7%9a%84%e7%bb%93%e6%9e%84%e5%8c%96%e7%9a%84DataSet%e6%88%96DataStream%29%e3%80%82Table%20API%20%e4%b8%8e%20DataSet%e5%92%8cDataStream%20API%20%e7%bb%93%e5%90%88%e7%b4%a7%e5%af%86%ef%bc%8cDataSet%20%e5%92%8c%20DataStream%e9%83%bd%e5%8f%af%e4%bb%a5%e5%be%88%e5%ae%b9%e6%98%93%e5%9c%b0%e8%bd%ac%e6%8d%a2%e6%88%90%20Table%ef%bc%8c%e5%90%8c%e6%a0%b7%e8%bd%ac%e6%8d%a2%e5%9b%9e%e6%9d%a5%e4%b9%9f%e5%be%88%e6%96%b9%e4%be%bf%ef%bc%9a%0aval%20execEnv%20%3d%20ExecutionEnvironment.getExecutionEnvironment%20val%20tableEnv%20%3d%20TableEnvironment.getTableEnvironment%28execEnv%29%20%2f%2f%20obtain%20a%20DataSet%20from%20somewhere%20val%20tempData%3a%20DataSet%5b%28String%2c%20Long%2c%20Double%29%5d%20%3d%20%2f%2f%20convert%20the%20DataSet%20to%20a%20Table%20val%20tempTable%3a%20Table%20%3d%20tempData.toTable%28tableEnv%2c%20%26%2339%3blocation%2c%20%26%2339%3btime%2c%20%26%2339%3btempF%29%20%2f%2f%20compute%20your%20result%20val%20avgTempCTable%3a%20Table%20%3d%20tempTable%20.where%28%26%2339%3blocation.like%28%26%2334%3broom%25%26%2334%3b%29%29%20.select%28%20%28%26%2339%3btime%20%2f%20%283600%20%2a%2024%29%29%20as%20%26%2339%3bday%2c%20%26%2339%3bLocation%20as%20%26%2339%3broom%2c%20%28%28%26%2339%3btempF%20-%2032%29%20%2a%200." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&t=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#从何而来>从何而来</a></li><li><a href=#table-api-和-sql-紧密结合>Table API 和 SQL 紧密结合</a></li><li><a href=#table-api的现状>Table API的现状</a><ul><li><a href=#batch-sql--table-api-支持>Batch SQL & Table API 支持:</a></li><li><a href=#streaming-table-api-支持>Streaming Table API 支持:</a></li><li><a href=#streaming-sql>Streaming SQL:</a></li></ul></li><li><a href=#streaming-sql案例>Streaming SQL案例</a><ul><li><a href=#持续的etl和数据导入>持续的ETL和数据导入</a></li><li><a href=#实时的dashboards-和-报表>实时的Dashboards 和 报表</a></li><li><a href=#即席分析>即席分析</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">浅析 Flink Table/SQL API</h1><div class=meta><div class=postdate><time datetime="2017-03-21 22:30:27 +0800 CST" itemprop=datePublished>2017-03-21</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/big-data>big-data</a>
,
<a class=category-link href=/categories/flink>flink</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/big-data rel=tag>big-data</a>
,
<a class=tag-link href=/tags/flink rel=tag>flink</a></div></div></header><div class=content itemprop=articleBody><h2 id=从何而来>从何而来</h2><p>关系型API有很多好处：是声明式的，用户只需要告诉需要什么，系统决定如何计算；用户不必特地实现；更方便优化，可以执行得更高效。本身Flink就是一个统一批和流的分布式计算平台，所以社区设计关系型API的目的之一是可以让关系型API作为统一的一层，两种查询拥有同样的语义和语法。大多数流处理框架的API都是比较low-level的API，学习成本高而且很多逻辑需要写到UDF中，所以Apache Flink 添加了SQL-like的API处理关系型数据&ndash;Table API。这套API中最重要的概念是<code>Table</code>(可以在上面进行关系型操作的结构化的DataSet或DataStream)。<code>Table</code> API 与 <code>DataSet</code>和<code>DataStream</code> API 结合紧密，DataSet 和 DataStream都可以很容易地转换成 Table，同样转换回来也很方便：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>val</span> execEnv <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>ExecutionEnvironment</span><span style=color:#f92672>.</span>getExecutionEnvironment
<span style=color:#66d9ef>val</span> tableEnv <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>TableEnvironment</span><span style=color:#f92672>.</span>getTableEnvironment<span style=color:#f92672>(</span>execEnv<span style=color:#f92672>)</span>

<span style=color:#75715e>// obtain a DataSet from somewhere
</span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> tempData<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>DataSet</span><span style=color:#f92672>[(</span><span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>Double</span><span style=color:#f92672>)]</span> <span style=color:#66d9ef>=</span>

<span style=color:#75715e>// convert the DataSet to a Table
</span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> tempTable<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Table</span> <span style=color:#f92672>=</span> tempData<span style=color:#f92672>.</span>toTable<span style=color:#f92672>(</span>tableEnv<span style=color:#f92672>,</span> &#39;location<span style=color:#f92672>,</span> &#39;time<span style=color:#f92672>,</span> &#39;tempF<span style=color:#f92672>)</span>
<span style=color:#75715e>// compute your result
</span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> avgTempCTable<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Table</span> <span style=color:#f92672>=</span> tempTable
 <span style=color:#f92672>.</span>where<span style=color:#f92672>(</span>&#39;location<span style=color:#f92672>.</span>like<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;room%&#34;</span><span style=color:#f92672>))</span>
 <span style=color:#f92672>.</span>select<span style=color:#f92672>(</span>
   <span style=color:#f92672>(</span>&#39;time <span style=color:#f92672>/</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>3600</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span><span style=color:#f92672>))</span> as &#39;day<span style=color:#f92672>,</span> 
   &#39;Location as &#39;room<span style=color:#f92672>,</span> 
   <span style=color:#f92672>((</span>&#39;tempF <span style=color:#f92672>-</span> <span style=color:#ae81ff>32</span><span style=color:#f92672>)</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.556</span><span style=color:#f92672>)</span> as &#39;tempC
  <span style=color:#f92672>)</span>
 <span style=color:#f92672>.</span>groupBy<span style=color:#f92672>(</span>&#39;day<span style=color:#f92672>,</span> &#39;room<span style=color:#f92672>)</span>
 <span style=color:#f92672>.</span>select<span style=color:#f92672>(</span>&#39;day<span style=color:#f92672>,</span> &#39;room<span style=color:#f92672>,</span> &#39;tempC<span style=color:#f92672>.</span>avg as &#39;avgTempC<span style=color:#f92672>)</span>
<span style=color:#75715e>// convert result Table back into a DataSet and print it
</span><span style=color:#75715e></span>avgTempCTable<span style=color:#f92672>.</span>toDataSet<span style=color:#f92672>[</span><span style=color:#66d9ef>Row</span><span style=color:#f92672>].</span>print<span style=color:#f92672>()</span>
</code></pre></div><p>example使用的是Scala的API，Java版API也有同样的功能。</p><p>下图展示了 Table API 的架构:</p><p><img src=https://dn-mtunique.qbox.me/flink_table_arch.jpg alt></p><p>从 DataSet 或 DataStream 创建一个 Table，然后在上面进行关系型操作比如 <code>fliter</code>、<code>join</code>、<code>select</code>。对Table的操作将会转换成逻辑运算符树。Table 转换回 DataSet 和 DataStream 的时候将会转换成DataSet 和 DataStream的算子。有些类似 <code>'location.like("room%")</code> 的表达式将会通过 <code>code generation</code> 编译成Flink的函数。</p><p>然而，最初传统的Table API 有一定的限制。首先，它不能独立使用。Table API 的 query 必须嵌入到 DataSet 或 DataStream的程序中。对批处理表的查询不支持<code>outer join</code>，<code>sorting</code>和很多SQL中常见的标量函数。对于流处理的查询只支持<code>filtetr</code> <code>union</code> 和 <code>projection</code>，不支持<code>aggregation</code>和<code>join</code>。而且，转换过程中没有利用太多查询优化技术，除了适用于所有DataSet程序的优化。</p><h2 id=table-api-和-sql-紧密结合>Table API 和 SQL 紧密结合</h2><p>随着流处理的日益普及和Flink在该领域的增长，Flink社区认为需要一个更简单的API使更多的用户能够分析流数据。一年前Flink社区决定将Table API提升到一个新的层级，扩展Table API中流处理的能力以及支持SQL。社区不想重复造轮子，于是决定在 <a href=https://calcite.apache.org/>Apache Calcite</a> (一个比较流行的SQL解析和优化框架)的基础上构建新的 Table API。Apache Calcite 被用在很多项目中，包括 Apache Hive，Apache Drill，Cascading等等。除此之外，Calcite社区将 <a href=https://calcite.apache.org/docs/stream.html>SQL on Stream</a> 写入它的roadmap，所以Flink的SQL很适合和它结合。</p><p>以Calcite为核心的新架构图:</p><p><img src=https://dn-mtunique.qbox.me/flink_sql_arch.jpg alt></p><p>新架构提供两种API进行关系型查询，Table API 和 SQL。这两种API的查询都会用包含注册过的Table的catalog进行验证，然后转换成统一Calcite的logical plan。在这种表示中，stream和batch的查询看起来完全一样。下一步，利用 Calcite的 cost-based 优化器优化转换规则和logical plan。根据数据源的性质(流式和静态)使用不同的规则进行优化。最终优化后的plan转传成常规的Flink DataSet 或 DataStream 程序。这步还涉及code generation（将关系表达式转换成Flink函数）。</p><p>下面我们举一个例子来理解新的架构。表达式转换成Logical Plan如下图所示：</p><p><img src=https://dn-mtunique.qbox.me/to_logical_plan.jpg alt></p><p>调用Table API 实际上是创建了很多 Table API 的 <code>LogicalNode</code>，创建的过程中对会对整个query进行validate。比如table是<code>CalalogNode</code>，window groupBy之后在select时会创建<code>WindowAggregate</code>和<code>Project</code>，where对应<code>Filter</code>。然后用<code>RelBuilder</code>翻译成Calcite LogicalPlan。如果是SQL API 将直接用Calcite的Parser进行解释然后validate生成Calcite LogicalPlan。</p><p><img src=https://dn-mtunique.qbox.me/trans.jpg alt></p><p>利用Calcite内置的一些rule来优化LogicalPlan，也可以自己添加或者覆盖这些rule。转换成Optimized Calcite Plan后，仍然是Calcite的内部表示方式，现在需要transform成DataStream Plan，对应上图第三列的类，里面封装了如何translate成普通的DataStream或DataSet程序。随后调用相应的<code>tanslateToPlan</code>方法转换和利用CodeGen元编程成Flink的各种算子。现在就相当于我们直接利用Flink的DataSet或DataStream API开发的程序。</p><p>Table API的新架构除了维持最初的原理还改进了很多。为流式数据和静态数据的关系查询保留统一的接口，而且利用了Calcite的查询优化框架和SQL parser。该设计是基于Flink已构建好的API构建的，DataStream API 提供低延时高吞吐的流处理能力而且就有exactly-once语义而且可以基于event-time进行处理。而且DataSet拥有稳定高效的内存算子和流水线式的数据交换。Flink的core API和引擎的所有改进都会自动应用到Table API和SQL上。</p><p>新的SQL接口集成到了Table API中。DataSteam， DataSet和外部数据源可以在TableEnvironment中注册成表，为了是他们可以通过SQL进行查询。<code>TableEnvironment.sql()</code>方法用来声明SQL和将结果作为Table返回。下面的是一个完整的样例，从一个JSON编码的Kafka topic中读取流表，然后用SQL处理并写到另一个Kafka topic。</p><pre><code>// get environments
val execEnv = StreamExecutionEnvironment.getExecutionEnvironment
val tableEnv = TableEnvironment.getTableEnvironment(execEnv)

// configure Kafka connection
val kafkaProps = ...
// define a JSON encoded Kafka topic as external table
val sensorSource = new KafkaJsonSource[(String, Long, Double)](
    &quot;sensorTopic&quot;,
    kafkaProps,
    (&quot;location&quot;, &quot;time&quot;, &quot;tempF&quot;))

// register external table
tableEnv.registerTableSource(&quot;sensorData&quot;, sensorSource)

// define query in external table
val roomSensors: Table = tableEnv.sql(
    &quot;SELECT STREAM time, location AS room, (tempF - 32) * 0.556 AS tempC &quot; +
    &quot;FROM sensorData &quot; +
    &quot;WHERE location LIKE 'room%'&quot;
  )

// define a JSON encoded Kafka topic as external sink
val roomSensorSink = new KafkaJsonSink(...)

// define sink for room sensor data and execute query
roomSensors.toSink(roomSensorSink)
execEnv.execute()
</code></pre><p>这个样例中忽略了流处理中最有趣的部分：window aggregate 和 join。这些操作如何用SQL表达呢？Apache Calcite社区提出了一个proposal来讨论<a href=https://calcite.apache.org/docs/stream.html>SQL on streams</a>的语法和语义。社区将Calcite的stream SQL描述为标准SQL的扩展而不是另外的 SQL-like语言。这有很多好处，首先，熟悉SQL标准的人能够在不学习新语法的情况下分析流数据。静态表和流表的查询几乎相同，可以轻松地移植。此外，可以同时在静态表和流表上进行查询，这和flink的愿景是一样的，将批处理看做特殊的流处理(批看作是有限的流)。最后，使用标准SQL进行流处理意味着有很多成熟的工具支持。</p><p>下面的example展示了如何用SQL和Table API进行滑动窗口查询:</p><p>SQL</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> STREAM
  TUMBLE_END(time, INTERVAL <span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#66d9ef>DAY</span>) <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>day</span>,
  <span style=color:#66d9ef>location</span> <span style=color:#66d9ef>AS</span> room,
  <span style=color:#66d9ef>AVG</span>((tempF <span style=color:#f92672>-</span> <span style=color:#ae81ff>32</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>556</span>) <span style=color:#66d9ef>AS</span> avgTempC
<span style=color:#66d9ef>FROM</span> sensorData
<span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>location</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;room%&#39;</span>
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> TUMBLE(time, INTERVAL <span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#66d9ef>DAY</span>), <span style=color:#66d9ef>location</span>
</code></pre></div><p>Table API</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>val</span> avgRoomTemp<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Table</span> <span style=color:#f92672>=</span> tableEnv<span style=color:#f92672>.</span>ingest<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sensorData&#34;</span><span style=color:#f92672>)</span>
  <span style=color:#f92672>.</span>where<span style=color:#f92672>(</span>&#39;location<span style=color:#f92672>.</span>like<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;room%&#34;</span><span style=color:#f92672>))</span>
  <span style=color:#f92672>.</span>partitionBy<span style=color:#f92672>(</span>&#39;location<span style=color:#f92672>)</span>
  <span style=color:#f92672>.</span>window<span style=color:#f92672>(</span><span style=color:#a6e22e>Tumbling</span> every <span style=color:#a6e22e>Days</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>)</span> on &#39;time as &#39;w<span style=color:#f92672>)</span>
  <span style=color:#f92672>.</span>select<span style=color:#f92672>(</span>&#39;w<span style=color:#f92672>.</span>end<span style=color:#f92672>,</span> &#39;location<span style=color:#f92672>,</span> <span style=color:#f92672>,</span> <span style=color:#f92672>((</span>&#39;tempF <span style=color:#f92672>-</span> <span style=color:#ae81ff>32</span><span style=color:#f92672>)</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.556</span><span style=color:#f92672>).</span>avg as &#39;avgTempCs<span style=color:#f92672>)</span>
</code></pre></div><h2 id=table-api的现状>Table API的现状</h2><h3 id=batch-sql--table-api-支持>Batch SQL & Table API 支持:</h3><ul><li>Selection, Projection, Sort, Inner & Outer Joins, Set operations</li><li>Windows for Slide, Tumble, Session</li></ul><h3 id=streaming-table-api-支持>Streaming Table API 支持:</h3><ul><li>Selection, Projection, Union</li><li>Windows for Slide, Tumble, Session</li></ul><h3 id=streaming-sql>Streaming SQL:</h3><ul><li>Selection, Projection, Union, Tumble</li></ul><h2 id=streaming-sql案例>Streaming SQL案例</h2><h3 id=持续的etl和数据导入>持续的ETL和数据导入</h3><p><img src=https://dn-mtunique.qbox.me/flink_stream_etl.jpg alt></p><p>获取流式数据，然后转换这些数据（归一化，聚合&mldr;），将其写入其他系统（File，Kafka，DBMS）。这些query的结果通常会存储到log-style的系统。</p><h3 id=实时的dashboards-和-报表>实时的Dashboards 和 报表</h3><p><img src=https://dn-mtunique.qbox.me/flink_online_dashboard.jpg alt></p><p>获取流式数据，然后对数据进行聚合来支持在线系统（dashboard，推荐）或者数据分析系统（Tableau）。通常结果被写到k-v存储中（Cassandra，Hbase，可查询的Flink状态），建立索引（Elasticsearch）或者DBMS（MySQL，PostgreSQL&mldr;）。这些查询通常可以被更新，改进。</p><h3 id=即席分析>即席分析</h3><p><img src=https://dn-mtunique.qbox.me/flink_adhoc.jpg alt></p><p>针对流数据的即席查询，以实时的方式进行分析和浏览数据。查询结果直接显示在notebook（Apache Zeppelin）中。</p><p>Flink社区还提出来和数据库中<code>Materialized View</code>很相似的<code>Dynamic table 动态表</code>概念，将在以后的版本中支持，具体细节将另开文章解释。</p></div></article><div class=blog-post-comments><div id=disqus_thread><script type=text/javascript>(function(){var a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,b='mtunique',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#从何而来>从何而来</a></li><li><a href=#table-api-和-sql-紧密结合>Table API 和 SQL 紧密结合</a></li><li><a href=#table-api的现状>Table API的现状</a><ul><li><a href=#batch-sql--table-api-支持>Batch SQL & Table API 支持:</a></li><li><a href=#streaming-table-api-支持>Streaming Table API 支持:</a></li><li><a href=#streaming-sql>Streaming SQL:</a></li></ul></li><li><a href=#streaming-sql案例>Streaming SQL案例</a><ul><li><a href=#持续的etl和数据导入>持续的ETL和数据导入</a></li><li><a href=#实时的dashboards-和-报表>实时的Dashboards 和 报表</a></li><li><a href=#即席分析>即席分析</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&text=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&title=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&is_video=false&description=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API&body=Check out this article: https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&title=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&title=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&name=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API&description=%e4%bb%8e%e4%bd%95%e8%80%8c%e6%9d%a5%20%e5%85%b3%e7%b3%bb%e5%9e%8bAPI%e6%9c%89%e5%be%88%e5%a4%9a%e5%a5%bd%e5%a4%84%ef%bc%9a%e6%98%af%e5%a3%b0%e6%98%8e%e5%bc%8f%e7%9a%84%ef%bc%8c%e7%94%a8%e6%88%b7%e5%8f%aa%e9%9c%80%e8%a6%81%e5%91%8a%e8%af%89%e9%9c%80%e8%a6%81%e4%bb%80%e4%b9%88%ef%bc%8c%e7%b3%bb%e7%bb%9f%e5%86%b3%e5%ae%9a%e5%a6%82%e4%bd%95%e8%ae%a1%e7%ae%97%ef%bc%9b%e7%94%a8%e6%88%b7%e4%b8%8d%e5%bf%85%e7%89%b9%e5%9c%b0%e5%ae%9e%e7%8e%b0%ef%bc%9b%e6%9b%b4%e6%96%b9%e4%be%bf%e4%bc%98%e5%8c%96%ef%bc%8c%e5%8f%af%e4%bb%a5%e6%89%a7%e8%a1%8c%e5%be%97%e6%9b%b4%e9%ab%98%e6%95%88%e3%80%82%e6%9c%ac%e8%ba%abFlink%e5%b0%b1%e6%98%af%e4%b8%80%e4%b8%aa%e7%bb%9f%e4%b8%80%e6%89%b9%e5%92%8c%e6%b5%81%e7%9a%84%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%a1%e7%ae%97%e5%b9%b3%e5%8f%b0%ef%bc%8c%e6%89%80%e4%bb%a5%e7%a4%be%e5%8c%ba%e8%ae%be%e8%ae%a1%e5%85%b3%e7%b3%bb%e5%9e%8bAPI%e7%9a%84%e7%9b%ae%e7%9a%84%e4%b9%8b%e4%b8%80%e6%98%af%e5%8f%af%e4%bb%a5%e8%ae%a9%e5%85%b3%e7%b3%bb%e5%9e%8bAPI%e4%bd%9c%e4%b8%ba%e7%bb%9f%e4%b8%80%e7%9a%84%e4%b8%80%e5%b1%82%ef%bc%8c%e4%b8%a4%e7%a7%8d%e6%9f%a5%e8%af%a2%e6%8b%a5%e6%9c%89%e5%90%8c%e6%a0%b7%e7%9a%84%e8%af%ad%e4%b9%89%e5%92%8c%e8%af%ad%e6%b3%95%e3%80%82%e5%a4%a7%e5%a4%9a%e6%95%b0%e6%b5%81%e5%a4%84%e7%90%86%e6%a1%86%e6%9e%b6%e7%9a%84API%e9%83%bd%e6%98%af%e6%af%94%e8%be%83low-level%e7%9a%84API%ef%bc%8c%e5%ad%a6%e4%b9%a0%e6%88%90%e6%9c%ac%e9%ab%98%e8%80%8c%e4%b8%94%e5%be%88%e5%a4%9a%e9%80%bb%e8%be%91%e9%9c%80%e8%a6%81%e5%86%99%e5%88%b0UDF%e4%b8%ad%ef%bc%8c%e6%89%80%e4%bb%a5Apache%20Flink%20%e6%b7%bb%e5%8a%a0%e4%ba%86SQL-like%e7%9a%84API%e5%a4%84%e7%90%86%e5%85%b3%e7%b3%bb%e5%9e%8b%e6%95%b0%e6%8d%ae%26ndash%3bTable%20API%e3%80%82%e8%bf%99%e5%a5%97API%e4%b8%ad%e6%9c%80%e9%87%8d%e8%a6%81%e7%9a%84%e6%a6%82%e5%bf%b5%e6%98%afTable%28%e5%8f%af%e4%bb%a5%e5%9c%a8%e4%b8%8a%e9%9d%a2%e8%bf%9b%e8%a1%8c%e5%85%b3%e7%b3%bb%e5%9e%8b%e6%93%8d%e4%bd%9c%e7%9a%84%e7%bb%93%e6%9e%84%e5%8c%96%e7%9a%84DataSet%e6%88%96DataStream%29%e3%80%82Table%20API%20%e4%b8%8e%20DataSet%e5%92%8cDataStream%20API%20%e7%bb%93%e5%90%88%e7%b4%a7%e5%af%86%ef%bc%8cDataSet%20%e5%92%8c%20DataStream%e9%83%bd%e5%8f%af%e4%bb%a5%e5%be%88%e5%ae%b9%e6%98%93%e5%9c%b0%e8%bd%ac%e6%8d%a2%e6%88%90%20Table%ef%bc%8c%e5%90%8c%e6%a0%b7%e8%bd%ac%e6%8d%a2%e5%9b%9e%e6%9d%a5%e4%b9%9f%e5%be%88%e6%96%b9%e4%be%bf%ef%bc%9a%0aval%20execEnv%20%3d%20ExecutionEnvironment.getExecutionEnvironment%20val%20tableEnv%20%3d%20TableEnvironment.getTableEnvironment%28execEnv%29%20%2f%2f%20obtain%20a%20DataSet%20from%20somewhere%20val%20tempData%3a%20DataSet%5b%28String%2c%20Long%2c%20Double%29%5d%20%3d%20%2f%2f%20convert%20the%20DataSet%20to%20a%20Table%20val%20tempTable%3a%20Table%20%3d%20tempData.toTable%28tableEnv%2c%20%26%2339%3blocation%2c%20%26%2339%3btime%2c%20%26%2339%3btempF%29%20%2f%2f%20compute%20your%20result%20val%20avgTempCTable%3a%20Table%20%3d%20tempTable%20.where%28%26%2339%3blocation.like%28%26%2334%3broom%25%26%2334%3b%29%29%20.select%28%20%28%26%2339%3btime%20%2f%20%283600%20%2a%2024%29%29%20as%20%26%2339%3bday%2c%20%26%2339%3bLocation%20as%20%26%2339%3broom%2c%20%28%28%26%2339%3btempF%20-%2032%29%20%2a%200." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmtunique.com%2fposts%2fflink_sql%2f&t=%e6%b5%85%e6%9e%90%20Flink%20Table%2fSQL%20API" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick="return $('#toc-footer').toggle(),!1" aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2021 mtunique</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>